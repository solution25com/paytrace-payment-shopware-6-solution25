(()=>{"use strict";class e extends window.PluginBaseClass{_registerElements(){this.confirmOrderForm=document.forms[this.options.confirmFormId],this.parentCreditCardWrapper=document.getElementById(this.options.parentCreditCardWrapperId),this.clientKey=this.parentCreditCardWrapper.getAttribute("data-client-key"),this.amount=this.parentCreditCardWrapper.getAttribute("data-amount"),this.cardsDropdown=this.parentCreditCardWrapper.getAttribute("data-cardsDropdown"),this.errorEl=document.getElementById("credit-card-error-message"),this.parentCreditCardWrapper.querySelectorAll(".paytrace-form-container input"),this.saveCardCheckbox=document.getElementById("save-paytrace-card"),this.jsDataEl=document.getElementById("paytrace-jsData"),this.translations=this.jsDataEl?JSON.parse(this.jsDataEl.dataset.jsdata).translations:{}}init(){this._registerElements(),this._registerEvents(),this._populateDropdown(),this._setupPayTrace()}_populateDropdown(){let e=document.getElementById("saved-cards");if(!e)return;let t=JSON.parse(this.cardsDropdown);e.innerHTML="";let r=document.createElement("option");r.value="__new__",r.textContent=this._t("optionUseNewCard"),e.appendChild(r),t.forEach(t=>{let r=document.createElement("option");r.value=t.vaultedCustomerId,r.textContent=t.cardType+" - **** **** **** "+t.lastDigits,e.appendChild(r)})}_setupPayTrace(){PTPayment.setup({styles:{cc:{background_color:"#ffffff",border_color:"#ced4da",border_style:"solid",font_color:"#495057",font_size:"14px",input_border_radius:"6px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"3px 0px 10px 0px",input_padding:"3px 8px 3px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"12px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"30px",width:"95%",padding_bottom:"4px"},code:{background_color:"#ffffff",border_color:"#ced4da",border_style:"solid",font_color:"#495057",font_size:"14px",input_border_radius:"6px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"5px 0px 10px 0px",input_padding:"4px 8px 4px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"13px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"30px",width:"95%",padding_bottom:"4px"},exp:{background_color:"#ffffff",border_color:"#ced4da",border_style:"solid",font_color:"#495057",font_size:"14px",input_border_radius:"6px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"5px 0px 10px 0px",input_padding:"4px 8px 4px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"13px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"40px",width:"40%",padding_bottom:"4px",type:"dropdown"},body:{background_color:"#ffffff"}},authorization:{clientKey:this.clientKey}}).then(()=>{PTPayment.theme("label-extended-top"),console.warn("PayTrace setup complete")}).catch(e=>{console.error("Error during PayTrace setup:",e),this._showError(this._t("paytrace_shopware6.credit_card.submitError.initFail"))})}_registerEvents(){this.confirmOrderForm.addEventListener("submit",e=>{var t;e.preventDefault(),e.stopPropagation(),this._hideError(),this._disableSubmit(),this._showLoading();let r=(t=document.getElementById("saved-cards"))===null||void 0===t?void 0:t.value;r&&"__new__"!==r?this._vaultedPayment():PTPayment.validate(e=>{if(e.length>0){this._handleValidationErrors(e),this._hideLoading();return}this._getCardToken()})});let e=document.getElementById("saved-cards"),t=document.getElementById("new-card-section");if(e&&t){e.addEventListener("change",e=>{"__new__"===e.target.value?t.style.display="block":t.style.display="none",this._hideError()});let r=new Event("change");e.dispatchEvent(r)}this.parentCreditCardWrapper.querySelectorAll("input, select").forEach(e=>{e.addEventListener("input",()=>this._hideError(e))})}_handleValidationErrors(e){PTPayment.style({cc:{border_color:"#ced4da"},exp:{border_color:"#ced4da"},code:{border_color:"#ced4da"}});let t=[];if(e.forEach(e=>{"35"===e.responseCode&&(PTPayment.style({cc:{border_color:"red"}}),t.push(e.description)),"43"===e.responseCode&&(PTPayment.style({exp:{border_color:"red"}}),t.push(e.description)),"148"===e.responseCode&&(PTPayment.style({code:{border_color:"red"}}),t.push(e.description))}),t.length>0){let e=t.map((e,t)=>"".concat(t+1,") ").concat(e)).join("<br>");this._showError(e),this._hideLoading()}else this._getCardToken()}_getCardToken(){PTPayment.process().then(e=>{e.message?this._submitPayment(e.message):(this._showError(this._t("paytrace_shopware6.credit_card.submitError.cardTokenFail")),this._hideLoading())}).catch(e=>{console.error("Error during payment processing:",e),this._showError(this._t("paytrace_shopware6.credit_card.submitError.processError")),this._hideLoading()})}_vaultedPayment(){let e=document.getElementById("saved-cards").value;if(!e){this._showError(this._t("paytrace_shopware6.credit_card.submitError.vaultedMissing")),this._hideLoading();return}this._showLoading(),this._submitVaultedPayment(e,this.amount)}_showNote(){document.getElementById("paytrace-card-note-message").classList.remove("d-none")}_submitPayment(e){var t;fetch("/capture-paytrace",{method:"POST",body:JSON.stringify({token:e,amount:this.amount,saveCard:((t=this.saveCardCheckbox)===null||void 0===t?void 0:t.checked)||!1}),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{this._hideLoading(),e.success?(this._hideError(),document.getElementById("payTrace-transaction-id").value=e.transactionId,this.confirmOrderForm.submit()):(console.error("Payment failed:",e.message||"Unknown error"),this._showError(e.message||this._t("paytrace_shopware6.credit_card.submitError.paymentFailed")),this._hideLoading())}).catch(e=>{this._hideLoading(),console.error("Payment submission failed:",e),this._showError(this._t("paytrace_shopware6.credit_card.submitError.unknown"))})}_submitVaultedPayment(e,t){fetch("/vaulted-capture-paytrace",{method:"POST",body:JSON.stringify({selectedCardVaultedId:e,amount:t}),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success?(this._hideError(),document.getElementById("payTrace-transaction-id").value=e.transactionId,this.confirmOrderForm.submit()):(console.error("Vaulted payment failed:",e.message||"Unknown error"),this._showError(e.message||this._t("paytrace_shopware6.credit_card.submitError.vaultedError")),this._hideLoading())}).catch(e=>{console.error("Vaulted payment submission failed:",e),this._showError(this._t("paytrace_shopware6.credit_card.submitError.vaultedUnknown")),this._hideLoading()})}_showError(e){this.errorEl&&(this.errorEl.innerHTML=e,this.errorEl.classList.remove("d-none")),this._enableSubmit(),this._hideLoading()}_hideError(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.errorEl&&(this.errorEl.innerHTML="",this.errorEl.classList.add("d-none")),e?PTPayment.style({[e.name]:{border_color:"#ced4da"}}):PTPayment.style({cc:{border_color:"#ced4da"},exp:{border_color:"#ced4da"},code:{border_color:"#ced4da"}}),document.getElementById("paytrace-card-note-message").classList.add("d-none"),this._enableSubmit()}_disableSubmit(){let e=this.confirmOrderForm.querySelector('button[type="submit"]');e&&(e.disabled=!0),e.classList.add("is-loading");let t=document.getElementById("saved-cards");t&&(t.disabled=!0)}_enableSubmit(){let e=this.confirmOrderForm.querySelector('button[type="submit"]');if(e){e.disabled=!1;let t=e.querySelector(".loader");t&&t.remove()}let t=document.getElementById("saved-cards");t&&(t.disabled=!1)}_t(e){return this.translations[e]||e}_showLoading(){let e=document.getElementById("paytrace-loading-indicator");e&&e.classList.remove("d-none"),this._disableSaveCardCheckbox()}_hideLoading(){let e=document.getElementById("paytrace-loading-indicator");e&&e.classList.add("d-none"),this._enableSaveCardCheckbox()}_disableSaveCardCheckbox(){this.saveCardCheckbox&&(this.saveCardCheckbox.disabled=!0)}_enableSaveCardCheckbox(){this.saveCardCheckbox&&(this.saveCardCheckbox.disabled=!1)}}e.options={confirmFormId:"confirmOrderForm",parentCreditCardWrapperId:"payTrace_payment"};class t extends window.PluginBaseClass{init(){this._registerElements(),this._bindEvents(),this._loadPayTraceKey()}_registerElements(){this.confirmOrderForm=document.forms[this.options.confirmFormId],this.parentCreditCardWrapper=document.getElementById(this.options.parentCreditCardWrapperId),this.amount=this.parentCreditCardWrapper.getAttribute("data-amount"),this.errorEl=document.getElementById("ach-error-message"),this.jsDataEl=document.getElementById("paytrace-ach-jsData"),this.translations=this.jsDataEl?JSON.parse(this.jsDataEl.dataset.jsdata).translations:{}}_loadPayTraceKey(){paytrace.setKeyAjax(this.options.publicKeyUrl)}_bindEvents(){this.confirmOrderForm&&this.confirmOrderForm.addEventListener("submit",e=>{e.preventDefault(),e.stopPropagation(),this._hideError();let t=document.getElementById(this.options.parentCreditCardWrapperId);t&&t.scrollIntoView({behavior:"smooth",block:"start"}),this._disableSubmit(),this._disableFormInputs(),this._showLoading(),this._getEncryptedTokens()})}_getEncryptedTokens(){var e;paytrace.setKeyAjax(this.options.publicKeyUrl);let t=document.getElementById("achRoutingNumber").value,r=document.getElementById("achAccountNumber"),a=document.getElementById("ach-full-name").value,o=(e=document.querySelector('input[name="accountType"]:checked'))===null||void 0===e?void 0:e.value;if(!t||!r||!o){this._hideLoading(),this._showError(this._t("paytrace_shopware6.ach_echeck.submitError.missingFields"));return}let i=paytrace.encryptValue(r.value);this._submitPayment(t,i,a,o)}_submitPayment(e,t,r,a){let o={billingName:r,routingNumber:e,accountNumber:t,accountType:a,amount:this.amount};fetch("/process-echeck-deposit",{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success?(this._hideError(),this._hideLoading(),this.confirmOrderForm.submit(),this._hideLoading()):(this._hideLoading(),this._showNote(),this._showError(e.message||this._t("paytrace_shopware6.ach_echeck.submitError.paymentFailed")))}).catch(e=>{this._showError(this._t("paytrace_shopware6.ach_echeck.submitError.unknown")+" | "+e)})}_showError(e){this.errorEl&&(this.errorEl.innerHTML=e,this.errorEl.classList.remove("d-none")),this._enableSubmit(),this._enableFormInputs()}_showNote(){document.getElementById("paytrace-card-note-message").classList.remove("d-none")}_hideError(){this.errorEl&&(this.errorEl.innerHTML="",this.errorEl.classList.add("d-none")),document.getElementById("paytrace-card-note-message").classList.add("d-none"),this._enableSubmit(),this._enableFormInputs()}_disableSubmit(){let e=this.confirmOrderForm.querySelector('button[type="submit"]');e&&(e.disabled=!0)}_enableSubmit(){let e=this.confirmOrderForm.querySelector('button[type="submit"]');e&&(e.disabled=!1)}_t(e){return this.translations[e]||e}_showLoading(){let e=document.getElementById("paytrace-loading-indicator");e&&e.classList.remove("d-none")}_hideLoading(){let e=document.getElementById("paytrace-loading-indicator");e&&e.classList.add("d-none")}_disableFormInputs(){this.parentCreditCardWrapper.querySelectorAll("input, select, textarea").forEach(e=>{e.disabled=!0})}_enableFormInputs(){this.parentCreditCardWrapper.querySelectorAll("input, select, textarea").forEach(e=>{e.disabled=!1})}}t.options={confirmFormId:"confirmOrderForm",parentCreditCardWrapperId:"payTrace_payment",publicKeyUrl:"https://api.sandbox.paytrace.com/v3/e2ee/public-key.pem"};class r extends window.PluginBaseClass{init(){this.options.paymentToken=this.el.getAttribute("data-client-key"),this._registerElements(),this._bindEvents(),this._setupPayTrace()}_registerElements(){this.toggleBtn=this.el.querySelector("#toggleAddCardForm"),this.formContainer=this.el.querySelector("#addCardFormContainer"),this.protectFormButton=this.el.querySelector("#ProtectForm"),this.errorContainer=this.el.querySelector("#errorContainer"),this.jsDataEl=document.getElementById("paytrace-saved-cards-jsData"),this.translations=this.jsDataEl?JSON.parse(this.jsDataEl.dataset.jsdata).translations:{}}_bindEvents(){this.toggleBtn&&this.formContainer&&this.toggleBtn.addEventListener("click",()=>{let e="none"===this.formContainer.style.display;this.formContainer.style.display=e?"block":"none",this.toggleBtn.textContent=e?this._t("paytrace_shopware6.savedCards.js.toggle_hide_form"):this._t("paytrace_shopware6.savedCards.js.toggle_show_form")}),this.protectFormButton&&this.protectFormButton.addEventListener("click",this._handleFormSubmit.bind(this)),this.el.addEventListener("click",async e=>{if(e.target.closest(".delete-card-btn"))try{await this._handleDeleteCard(e)}catch(e){console.error("Error handling delete card:",e),this._showError([this._t("paytrace_shopware6.savedCards.js.error_delete_failed")])}})}_validateBillingData(){let e=[];for(let t of[{id:"nameSurname",name:"Name"},{id:"streetAddress",name:"Street Address"},{id:"city",name:"City"},{id:"state",name:"State"},{id:"postalCode",name:"Postal Code"},{id:"country",name:"Country"}]){let r=this.el.querySelector("#".concat(t.id));r&&r.value.trim()||e.push(this._t("paytrace_shopware6.savedCards.js.error_required_field").replace("{field}",t.name))}return!(e.length>0)||(this._showError(e),!1)}_showError(e){this.errorContainer&&(this.errorContainer.innerHTML="",this.errorContainer.style.display="block",e.forEach(e=>{let t=document.createElement("div");t.classList.add("error-message"),t.textContent=e,this.errorContainer.appendChild(t)}))}_clearError(){this.errorContainer&&(this.errorContainer.innerHTML="",this.errorContainer.style.display="none")}_setupPayTrace(){PTPayment.setup({authorization:{clientKey:this.options.paymentToken},styles:{cc:{background_color:"#ffffff",border_style:"solid",border_color:"#ced4da",input_border_radius:"6px",font_color:"#495057",font_size:"14px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"3px 0px 10px 0px",input_padding:"3px 8px 3px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"12px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"30px",width:"95%",padding_bottom:"4px"},code:{background_color:"#ffffff",border_style:"solid",border_color:"#ced4da",input_border_radius:"6px",font_color:"#495057",font_size:"14px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"5px 0px 10px 0px",input_padding:"4px 8px 4px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"13px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"30px",width:"95%",padding_bottom:"4px"},exp:{background_color:"#ffffff",border_style:"solid",border_color:"#ced4da",input_border_radius:"6px",font_color:"#495057",font_size:"14px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"5px 0px 10px 0px",input_padding:"4px 8px 4px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"13px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"40px",width:"40%",padding_bottom:"4px",type:"dropdown"},body:{background_color:"#ffffff"}}}).then(()=>{PTPayment.theme("label-extended-top")}).catch(e=>{console.error("Error during PayTrace setup:",e)})}async _handleFormSubmit(){if(!this._validateBillingData())return;this._showLoading();let e=e=>{var t;return((t=this.el.querySelector("#".concat(e)))===null||void 0===t?void 0:t.value)||""},t=e("streetAddress2"),r={name:e("nameSurname"),street_address:e("streetAddress"),...t&&{street_address2:t},city:e("city"),state:e("state"),postal_code:e("postalCode"),country:e("country")};try{let e=await PTPayment.process();if(!e.message){console.error("Failed to receive a card token"),this._hideLoading();return}let t=await fetch("/account/payTrace-saved-cards/add-card",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cardToken:e.message,billing_address:r})}),a=await t.json();a.error?(console.error("Error from backend:",a.message),this._hideLoading()):(this._hideLoading(),location.reload())}catch(e){console.error("Error during payment processing:",e),this._hideLoading()}}async _handleDeleteCard(e){let t=e.target.closest(".delete-card-btn");if(!t)return;let r=t.getAttribute("data-card-id");if(confirm(this._t("paytrace_shopware6.savedCards.js.error_confirm_delete"))){this._showDeleteLoading(t);try{let e=await fetch("/account/payTrace-saved-cards/delete-card/".concat(r),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cardId:r})}),t=await e.json();t.error?(console.error("Error:",t.message),this._showError([t.message||this._t("paytrace_shopware6.savedCards.js.error_delete_failed")])):location.reload()}catch(e){console.error("Error during delete request:",e),this._showError([this._t("paytrace_shopware6.savedCards.js.error_delete_failed")])}finally{this._hideDeleteLoading(t)}}}_t(e){return this.translations[e]||e}_showLoading(){let e=document.getElementById("paytrace-loading-indicator");e&&e.classList.remove("d-none")}_hideLoading(){let e=document.getElementById("paytrace-loading-indicator");e&&e.classList.add("d-none")}_showDeleteLoading(e){let t=e.closest(".saved-card").querySelector(".delete-loading-indicator");t&&t.classList.remove("d-none")}_hideDeleteLoading(e){let t=e.closest(".saved-card").querySelector(".delete-loading-indicator");t&&t.classList.add("d-none")}}r.options={paymentToken:""};let a=window.PluginManager;a.register("PayTraceCreditCardPlugin",e,"[payTrace-payment-credit-card-plugin]"),a.register("PayTraceAchECheckPlugin",t,"[payTrace-payment-ach-echeck-plugin]"),a.register("PayTraceSavedCardsPlugin",r,"[payTrace-saved-cards-plugin]")})();