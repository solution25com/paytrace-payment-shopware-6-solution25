(()=>{"use strict";class e extends window.PluginBaseClass{_registerElements(){this.confirmOrderForm=document.forms[this.options.confirmFormId],this.parentCreditCardWrapper=document.getElementById(this.options.parentCreditCardWrapperId),this.clientKey=this.parentCreditCardWrapper.getAttribute("data-client-key"),this.amount=this.parentCreditCardWrapper.getAttribute("data-amount"),this.cardsDropdown=this.parentCreditCardWrapper.getAttribute("data-cardsDropdown")}init(){this._registerElements(),this._populateDropdown(),this._setupPayTrace(),this._bindEvents()}_populateDropdown(){let e=JSON.parse(this.cardsDropdown),t=document.getElementById("saved-cards");t.innerHTML="";let r=document.createElement("option");r.value="",r.textContent="-- Select a saved card --",t.appendChild(r),e.forEach(e=>{let r=document.createElement("option");r.value=e.vaultedCustomerId,r.textContent=e.customerLabel,t.appendChild(r)})}_setupPayTrace(){PTPayment.setup({styles:{},authorization:{clientKey:this.clientKey}}).then(()=>{console.log("PayTrace setup complete")}).catch(e=>{console.error("Error during PayTrace setup:",e)})}_bindEvents(){document.getElementById("ProtectForm").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this._getCardToken()}),document.getElementById("SelectCardButton").addEventListener("click",e=>{e.preventDefault(),this._vaultedPayment()},{once:!0}),document.getElementById("saved-cards").addEventListener("change",e=>{let t=e.target.value,r=document.getElementById("SelectCardButton");t?r.style.display="block":r.style.display="none"})}_getCardToken(){PTPayment.process().then(e=>{e.message?this._submitPayment(e.message):console.error("Failed to receive a token:",e)}).catch(e=>{console.error("Error during payment processing:",e)})}_vaultedPayment(){let e=document.getElementById("saved-cards").value,t=this.amount;if(!e){alert("No card");return}this._submitVaultedPayment(e,t)}_submitPayment(e){fetch("/capture-paytrace",{method:"POST",body:JSON.stringify({token:e,amount:this.amount}),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success?(document.getElementById("payTrace-transaction-id").value=e.transactionId,document.getElementById("confirmOrderForm").submit()):console.error("Payment failed:",e.message||"Unknown error")}).catch(e=>{console.error("Payment submission failed:",e)})}_submitVaultedPayment(e,t){fetch("/vaulted-capture-paytrace",{method:"POST",body:JSON.stringify({selectedCardVaultedId:e,amount:t}),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success?(document.getElementById("payTrace-transaction-id").value=e.transactionId,document.getElementById("confirmOrderForm").submit()):console.error("Payment failed:",e.message||"Unknown error")}).catch(e=>{console.error("Payment submission failed:",e)})}}e.options={confirmFormId:"confirmOrderForm",parentCreditCardWrapperId:"payTrace_payment"};class t extends window.PluginBaseClass{init(){this._registerElements(),this._bindEvents(),this._loadPayTraceKey()}_registerElements(){this.confirmOrderForm=document.forms[this.options.confirmFormId],this.parentCreditCardWrapper=document.getElementById(this.options.parentCreditCardWrapperId),this.amount=this.parentCreditCardWrapper.getAttribute("data-amount")}_loadPayTraceKey(){paytrace.setKeyAjax(this.options.publicKeyUrl)}_bindEvents(){document.getElementById("submit-ach-payment").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this._getEncryptedTokens()})}_getEncryptedTokens(){paytrace.setKeyAjax(this.options.publicKeyUrl);let e=document.getElementById("achRoutingNumber"),t=document.getElementById("achAccountNumber"),r=document.getElementById("ach-full-name").value;if(!e||!t){console.error("Input fields not found!"),alert("Form fields missing!");return}let n=paytrace.encryptValue(e.value),a=paytrace.encryptValue(t.value);this._submitPayment(n,a,r)}_submitPayment(e,t,r){let n={billingName:r,routingNumber:e,accountNumber:t,amount:this.amount};fetch("/process-echeck-deposit",{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success?(console.log("Transaction Successful:",e),this.confirmOrderForm&&this.confirmOrderForm.submit()):(console.error("Payment failed:",e.message||"Unknown error"),alert("Payment failed: "+(e.message||"Unknown error")))}).catch(e=>{console.error("Payment submission failed:",e),alert("An error occurred while submitting the payment.")})}}t.options={confirmFormId:"confirmOrderForm",parentCreditCardWrapperId:"payTrace_payment",publicKeyUrl:"https://api.sandbox.paytrace.com/v3/e2ee/public-key.pem"};let r=window.PluginManager;r.register("PayTraceCreditCardPlugin",e,"[payTrace-payment-credit-card-plugin]"),r.register("PayTraceAchECheckPlugin",t,"[payTrace-payment-ach-echeck-plugin]")})();