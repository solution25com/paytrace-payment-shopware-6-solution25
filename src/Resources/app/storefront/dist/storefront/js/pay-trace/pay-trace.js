(()=>{"use strict";class e extends window.PluginBaseClass{_registerElements(){this.confirmOrderForm=document.forms[this.options.confirmFormId],this.parentCreditCardWrapper=document.getElementById(this.options.parentCreditCardWrapperId),this.clientKey=this.parentCreditCardWrapper.getAttribute("data-client-key"),this.amount=this.parentCreditCardWrapper.getAttribute("data-amount"),this.cardsDropdown=this.parentCreditCardWrapper.getAttribute("data-cardsDropdown"),this.errorEl=document.getElementById("error-message"),this.parentCreditCardWrapper.querySelectorAll(".paytrace-form-container input")}init(){this._registerElements(),this._registerEvents(),this._populateDropdown(),this._setupPayTrace()}_populateDropdown(){let e=document.getElementById("saved-cards");if(!e)return;let t=JSON.parse(this.cardsDropdown);e.innerHTML="";let r=document.createElement("option");r.value="",r.textContent="-- Select a saved card --",e.appendChild(r),t.forEach(t=>{let r=document.createElement("option");r.value=t.vaultedCustomerId,r.textContent=t.customerLabel,e.appendChild(r)})}_setupPayTrace(){PTPayment.setup({styles:{cc:{background_color:"#ffffff",border_color:"#ced4da",border_style:"solid",font_color:"#495057",font_size:"14px",input_border_radius:"6px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"3px 0px 10px 0px",input_padding:"3px 8px 3px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"12px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"32px",width:"95%",padding_bottom:"4px"},code:{background_color:"#ffffff",border_color:"#ced4da",border_style:"solid",font_color:"#495057",font_size:"14px",input_border_radius:"6px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"5px 0px 10px 0px",input_padding:"4px 8px 4px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"13px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"32px",width:"95%",padding_bottom:"4px"},exp:{background_color:"#ffffff",border_color:"#ced4da",border_style:"solid",font_color:"#495057",font_size:"14px",input_border_radius:"6px",input_border_width:"1px",input_font:"Segoe UI, sans-serif",input_font_weight:"400",input_margin:"5px 0px 10px 0px",input_padding:"4px 8px 4px 8px",label_color:"#495057",label_font:"Segoe UI, sans-serif",label_font_weight:"500",label_size:"13px",label_width:"auto",label_margin:"0 0 4px 0",label_padding:"0 4px",label_border_style:"none",height:"32px",width:"100%",padding_bottom:"4px",type:"dropdown"},body:{background_color:"#ffffff"}},authorization:{clientKey:this.clientKey}}).then(()=>{}).catch(e=>{console.error("Error during PayTrace setup:",e),this._showError("Failed to initialize payment system.")})}_registerEvents(){this.confirmOrderForm.addEventListener("submit",e=>{var t;if(e.preventDefault(),e.stopPropagation(),this._disableSubmit(),(t=document.getElementById("saved-cards"))===null||void 0===t?void 0:t.value){this._vaultedPayment();return}PTPayment.validate(e=>{if(e.length>0){this._handleValidationErrors(e);return}this._getCardToken()})});let e=document.getElementById("SelectCardButton"),t=document.getElementById("saved-cards");e&&t&&(t.addEventListener("change",t=>{t.target.value?e.style.display="block":e.style.display="none"}),e.addEventListener("click",e=>{e.preventDefault(),this._vaultedPayment()})),this.parentCreditCardWrapper.querySelectorAll("input, select").forEach(e=>{e.addEventListener("input",()=>this._hideError(e))})}_handleValidationErrors(e){PTPayment.style({cc:{border_color:"#ced4da"},exp:{border_color:"#ced4da"},code:{border_color:"#ced4da"}});let t=[];if(e.forEach(e=>{"35"===e.responseCode&&(PTPayment.style({cc:{border_color:"red"}}),t.push(e.description)),"43"===e.responseCode&&(PTPayment.style({exp:{border_color:"red"}}),t.push(e.description)),"148"===e.responseCode&&(PTPayment.style({code:{border_color:"red"}}),t.push(e.description))}),t.length>0){let e=t.map((e,t)=>"".concat(t+1,") ").concat(e)).join("<br>");this._showError(e)}else this._getCardToken()}_getCardToken(){PTPayment.process().then(e=>{e.message?this._submitPayment(e.message):this._showError("Failed to receive card token.")}).catch(e=>{console.error("Error during payment processing:",e),this._showError("An error occurred during card processing.")})}_vaultedPayment(){let e=document.getElementById("saved-cards").value;if(!e){this._showError("Please select a saved card before proceeding.");return}this._submitVaultedPayment(e,this.amount)}_submitPayment(e){fetch("/capture-paytrace",{method:"POST",body:JSON.stringify({token:e,amount:this.amount}),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success?(this._hideError(),document.getElementById("payTrace-transaction-id").value=e.transactionId,this.confirmOrderForm.submit()):(console.error("Payment failed:",e.message||"Unknown error"),this._showError(e.message||"Payment failed."))}).catch(e=>{console.error("Payment submission failed:",e),this._showError("An unexpected error occurred while submitting the payment.")})}_submitVaultedPayment(e,t){fetch("/vaulted-capture-paytrace",{method:"POST",body:JSON.stringify({selectedCardVaultedId:e,amount:t}),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success?(this._hideError(),document.getElementById("payTrace-transaction-id").value=e.transactionId,this.confirmOrderForm.submit()):(console.error("Vaulted payment failed:",e.message||"Unknown error"),this._showError(e.message||"Vaulted card payment failed."))}).catch(e=>{console.error("Vaulted payment submission failed:",e),this._showError("An unexpected error occurred while using a saved card.")})}_showError(e){this.errorEl&&(this.errorEl.innerHTML=e,this.errorEl.classList.remove("d-none")),this._enableSubmit()}_hideError(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.errorEl&&(this.errorEl.innerHTML="",this.errorEl.classList.add("d-none")),e&&PTPayment.style({[e.name]:{border_color:"#ced4da"}}),this._enableSubmit()}_disableSubmit(){let e=this.confirmOrderForm.querySelector('button[type="submit"]');e&&(e.disabled=!0)}_enableSubmit(){let e=this.confirmOrderForm.querySelector('button[type="submit"]');e&&(e.disabled=!1)}}e.options={confirmFormId:"confirmOrderForm",parentCreditCardWrapperId:"payTrace_payment"};class t extends window.PluginBaseClass{init(){this._registerElements(),this._bindEvents(),this._loadPayTraceKey()}_registerElements(){this.confirmOrderForm=document.forms[this.options.confirmFormId],this.parentCreditCardWrapper=document.getElementById(this.options.parentCreditCardWrapperId),this.amount=this.parentCreditCardWrapper.getAttribute("data-amount"),this.errorEl=document.getElementById("error-message")}_loadPayTraceKey(){paytrace.setKeyAjax(this.options.publicKeyUrl)}_bindEvents(){document.getElementById("submit-ach-payment").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this._getEncryptedTokens()})}_getEncryptedTokens(){paytrace.setKeyAjax(this.options.publicKeyUrl);let e=document.getElementById("achRoutingNumber"),t=document.getElementById("achAccountNumber"),r=document.getElementById("ach-full-name").value;if(!e||!t){this._showError("Form fields are missing.");return}let o=paytrace.encryptValue(e.value),n=paytrace.encryptValue(t.value);this._submitPayment(o,n,r)}_submitPayment(e,t,r){let o={billingName:r,routingNumber:e,accountNumber:t,amount:this.amount};fetch("/process-echeck-deposit",{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success?(this._hideError(),this.confirmOrderForm&&this.confirmOrderForm.submit()):this._showError(e.message||"Payment failed.")}).catch(e=>{this._showError("An unexpected error occurred while submitting the payment. | [object Object]")})}_showError(e){this.errorEl&&(this.errorEl.innerHTML=e,this.errorEl.classList.remove("d-none"))}_hideError(){this.errorEl&&(this.errorEl.innerHTML="",this.errorEl.classList.add("d-none"))}}t.options={confirmFormId:"confirmOrderForm",parentCreditCardWrapperId:"payTrace_payment",publicKeyUrl:"https://api.sandbox.paytrace.com/v3/e2ee/public-key.pem"};let r=window.PluginManager;r.register("PayTraceCreditCardPlugin",e,"[payTrace-payment-credit-card-plugin]"),r.register("PayTraceAchECheckPlugin",t,"[payTrace-payment-ach-echeck-plugin]")})();